<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”Š éŸ³é¢‘åˆ†äº«æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f2f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .test-section {
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .status-box {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 10px;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .instructions {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 20px;
            margin: 20px 0;
        }
        .video-container {
            width: 100%;
            max-width: 500px;
            height: 300px;
            background: #000;
            border-radius: 10px;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”Š å±å¹•åˆ†äº«éŸ³é¢‘æµ‹è¯•</h1>
            <p>æµ‹è¯•ç³»ç»ŸéŸ³é¢‘æ•è·åŠŸèƒ½</p>
        </div>

        <div class="instructions">
            <h3>ğŸ“‹ æµ‹è¯•æ­¥éª¤ï¼š</h3>
            <ol>
                <li>ç¡®ä¿ä½¿ç”¨ <strong>Chrome æµè§ˆå™¨</strong>ï¼ˆç‰ˆæœ¬74+ï¼‰</li>
                <li>ç‚¹å‡»ä¸‹æ–¹"å¼€å§‹æµ‹è¯•"æŒ‰é’®</li>
                <li>åœ¨å¼¹å‡ºçª—å£ä¸­é€‰æ‹©è¦åˆ†äº«çš„å†…å®¹</li>
                <li><strong>é‡è¦ï¼šå‹¾é€‰"åˆ†äº«ç³»ç»ŸéŸ³é¢‘"é€‰é¡¹</strong></li>
                <li>è§‚å¯ŸéŸ³é¢‘æ£€æµ‹ç»“æœ</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>ğŸ® æµ‹è¯•æ§åˆ¶</h3>
            <button id="startBtn" class="btn btn-primary" onclick="startTest()">
                ğŸš€ å¼€å§‹æµ‹è¯•å±å¹•éŸ³é¢‘åˆ†äº«
            </button>
            <button id="stopBtn" class="btn btn-danger" onclick="stopTest()" disabled>
                â¹ï¸ åœæ­¢æµ‹è¯•
            </button>

            <div class="video-container" id="videoContainer">
                ğŸ“º å±å¹•åˆ†äº«é¢„è§ˆåŒºåŸŸ
            </div>

            <div id="statusContainer"></div>
        </div>
    </div>

    <script>
        let currentStream = null;

        function showStatus(type, message) {
            const container = document.getElementById('statusContainer');
            const statusDiv = document.createElement('div');
            statusDiv.className = `status-box status-${type}`;
            statusDiv.innerHTML = message;
            container.appendChild(statusDiv);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            statusDiv.scrollIntoView({ behavior: 'smooth' });
        }

        async function startTest() {
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const videoContainer = document.getElementById('videoContainer');

            try {
                startBtn.disabled = true;
                
                // æ¸…ç©ºä¹‹å‰çš„çŠ¶æ€
                document.getElementById('statusContainer').innerHTML = '';
                
                showStatus('warning', 'ğŸš€ å¼€å§‹è¯·æ±‚å±å¹•åˆ†äº«æƒé™...');
                showStatus('warning', 'ğŸ’¡ è¯·åœ¨å¼¹å‡ºçª—å£ä¸­å‹¾é€‰"åˆ†äº«ç³»ç»ŸéŸ³é¢‘"é€‰é¡¹');

                // ğŸ¯ æ–°çš„å±å¹•åˆ†äº«é…ç½® - åŒ…å«éŸ³é¢‘
                const displayMediaOptions = {
                    video: {
                        mediaSource: 'screen',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        frameRate: { ideal: 30 }
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    },
                    // Chrome ç‰¹æœ‰çš„ç³»ç»ŸéŸ³é¢‘é€‰é¡¹
                    systemAudio: 'include',
                    selfBrowserSurface: 'exclude',
                    surfaceSwitching: 'include'
                };

                currentStream = await navigator.mediaDevices.getDisplayMedia(displayMediaOptions);
                
                // æ£€æŸ¥è·å–çš„è½¨é“
                const videoTracks = currentStream.getVideoTracks();
                const audioTracks = currentStream.getAudioTracks();

                showStatus('success', `ğŸ“º è§†é¢‘è½¨é“: ${videoTracks.length > 0 ? 'âœ… å·²è·å–' : 'âŒ æœªè·å–'}`);
                showStatus(audioTracks.length > 0 ? 'success' : 'error', 
                    `ğŸ”Š éŸ³é¢‘è½¨é“: ${audioTracks.length > 0 ? 'âœ… å·²è·å– (åŒ…å«ç³»ç»ŸéŸ³é¢‘!)' : 'âŒ æœªè·å–'}`);

                if (audioTracks.length > 0) {
                    const audioTrack = audioTracks[0];
                    const settings = audioTrack.getSettings();
                    showStatus('success', 'ğŸ‰ æˆåŠŸï¼ç°åœ¨å¯ä»¥åˆ†äº«ç³»ç»ŸéŸ³é¢‘äº†');
                    showStatus('success', `ğŸµ éŸ³é¢‘è®¾ç½®: ${settings.sampleRate}Hz, ${settings.channelCount}å£°é“`);
                    showStatus('success', 'âœ¨ åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå­¦ç”Ÿä»¬ç°åœ¨å¯ä»¥å¬åˆ°è§†é¢‘å£°éŸ³äº†ï¼');
                } else {
                    showStatus('error', 'âŒ æœªè·å–åˆ°ç³»ç»ŸéŸ³é¢‘');
                    showStatus('warning', 'å¯èƒ½åŸå› ï¼š');
                    showStatus('warning', 'â€¢ æœªå‹¾é€‰"åˆ†äº«ç³»ç»ŸéŸ³é¢‘"é€‰é¡¹');
                    showStatus('warning', 'â€¢ æµè§ˆå™¨ä¸æ”¯æŒç³»ç»ŸéŸ³é¢‘æ•è·');
                    showStatus('warning', 'â€¢ é€‰æ‹©çš„å†…å®¹æºä¸åŒ…å«éŸ³é¢‘');
                }

                // æ˜¾ç¤ºè§†é¢‘é¢„è§ˆ
                if (videoTracks.length > 0) {
                    const video = document.createElement('video');
                    video.srcObject = currentStream;
                    video.autoplay = true;
                    video.muted = true; // æœ¬åœ°é¢„è§ˆé™éŸ³ï¼Œé¿å…å›éŸ³
                    video.style.width = '100%';
                    video.style.height = '100%';
                    video.style.objectFit = 'contain';
                    
                    videoContainer.innerHTML = '';
                    videoContainer.appendChild(video);
                }

                // ç›‘å¬æµç»“æŸ
                currentStream.getTracks().forEach(track => {
                    track.addEventListener('ended', () => {
                        showStatus('warning', `ğŸ›‘ ${track.kind}è½¨é“å·²ç»“æŸ`);
                        if (currentStream.getTracks().every(t => t.readyState === 'ended')) {
                            stopTest();
                        }
                    });
                });

                stopBtn.disabled = false;
                showStatus('success', 'âœ… æµ‹è¯•å¯åŠ¨æˆåŠŸï¼');

            } catch (error) {
                showStatus('error', `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
                
                if (error.message.includes('Permission denied')) {
                    showStatus('warning', 'ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼š');
                    showStatus('warning', '1. ç‚¹å‡»"å…è®¸"æŒ‰é’®');
                    showStatus('warning', '2. é€‰æ‹©è¦åˆ†äº«çš„å±å¹•/çª—å£/æ ‡ç­¾é¡µ');
                    showStatus('warning', '3. ğŸ”Š é‡è¦ï¼šå‹¾é€‰"åˆ†äº«ç³»ç»ŸéŸ³é¢‘"é€‰é¡¹');
                } else if (error.message.includes('NotSupported')) {
                    showStatus('error', 'âŒ æµè§ˆå™¨ä¸æ”¯æŒï¼Œè¯·ä½¿ç”¨Chromeæµè§ˆå™¨');
                }
                
                startBtn.disabled = false;
            }
        }

        function stopTest() {
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const videoContainer = document.getElementById('videoContainer');

            if (currentStream) {
                currentStream.getTracks().forEach(track => {
                    track.stop();
                    showStatus('warning', `ğŸ›‘ åœæ­¢${track.kind}è½¨é“`);
                });
                currentStream = null;
            }

            videoContainer.innerHTML = 'ğŸ“º å±å¹•åˆ†äº«é¢„è§ˆåŒºåŸŸ';
            startBtn.disabled = false;
            stopBtn.disabled = true;
            showStatus('success', 'âœ… æµ‹è¯•å·²åœæ­¢');
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
        window.addEventListener('load', () => {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
                showStatus('error', 'âŒ æµè§ˆå™¨ä¸æ”¯æŒå±å¹•åˆ†äº«API');
                document.getElementById('startBtn').disabled = true;
                return;
            }

            const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            if (isChrome) {
                showStatus('success', 'âœ… Chromeæµè§ˆå™¨ - æ”¯æŒç³»ç»ŸéŸ³é¢‘æ•è·');
            } else {
                showStatus('warning', 'âš ï¸ å»ºè®®ä½¿ç”¨Chromeæµè§ˆå™¨ä»¥è·å¾—æœ€ä½³éŸ³é¢‘æ”¯æŒ');
            }

            if (window.isSecureContext) {
                showStatus('success', 'âœ… å®‰å…¨ä¸Šä¸‹æ–‡ - å¯ä»¥ä½¿ç”¨å±å¹•åˆ†äº«');
            } else {
                showStatus('error', 'âŒ éœ€è¦HTTPSæˆ–localhostç¯å¢ƒ');
            }
        });
    </script>
</body>
</html> 